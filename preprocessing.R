## Supress package information.
tmp.msg <- capture.output(
  suppressMessages({
    library(data.table);
    require(bit64);
    library(ForeCA)}))

##' Preprocess the original data.
##'
##' Data preprocessing including 1) remove useless features, 2)
##' centering and scaling features.  This function only need to be
##' called once.
##'
##' @param data.file Input data file
##' @param out.file Output data file, default to be "data.csv".
pp_once <- function(data.file, out.file="data/data.csv") {
  dt <- fread(data.file)
  setkey(dt, hash)

  dt$classification <- as.factor(dt$classification)
  dt$classification <- as.numeric(dt$classification)

  colSd <- function(x, na.rm=TRUE) {
    n <- ifelse(na.rm, colSums(!is.na(x)), nrow(x))
    col.var <- colMeans(x * x, na.rm=na.rm) - (colMeans(x, na.rm=na.rm))^2
    sqrt(col.var * n / (n - 1))
  }

  ## Remove milisecond.
  dt1 <- dt[, -2, with=F]
  dt1[, (2:ncol(dt1)) := lapply(.SD, as.numeric), .SDcols=2:ncol(dt1)]

  dt.avg <- dt1[, lapply(.SD, mean), by=hash]
  dt.part <- dt.avg[, -c(1, 2), with=F]
  dt.part.mean <- colMeans(dt.part)
  dt.part.sd <- colSd(dt.part)

  ## sd ~ 0 means only one value for this column, this is useless.
  useless <- which(dt.part.sd < 1e-6)
  dt.avg[, (useless + 2) := NULL, with=F]
  dt.part[, useless := NULL, with=F]
  dt.part.mean <- dt.part.mean[-useless]
  dt.part.sd <- dt.part.sd[-useless]

  ## centering
  dt.part <- sweep(dt.part, 2, dt.part.mean, "-")
  ## scaling
  dt.part <- sweep(dt.part, 2, dt.part.sd, "/")

  dt.avg[, 3:ncol(dt.avg) := dt.part, with=F]
  dt.clean <- dt.avg[, -1, with=F]
  write.csv(dt.clean, out.file, row.names=F)
}

## pp_once("data/exp_data_trial.csv")

##' Separate data into train and test set.
##'
##' Random sampling from each category, and separate the whole dataset
##' evenly into train and test set, which will be written into
##' "train.csv" and "test.csv" respectively.
##'
##' @param data.file Clean input data file.
gen_train_test <- function(data.file) {
  dt.clean <- fread(data.file)

  count <- dt.clean[, .N, by=classification]
  N <- min(count$N)

  train.index <- dt.clean[, sample(.I, N / 2), by=classification]
  train <- dt.clean[, .SD[train.index$V1]]
  test <- dt.clean[-(train.index$V1),]

  write.csv(train, "data/train.csv", row.names=F)
  write.csv(test, "data/test.csv", row.names=F)
}

gen_train_test("data/data.csv")
